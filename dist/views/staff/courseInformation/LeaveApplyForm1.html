<div class="layui-form" lay-filter="layuiadmin-app-form-list" id="layuiadmin-app-form-list" style="padding: 20px 30px 0 0;">
	<div class="layui-form-item">
		<label class="layui-form-label">课程类型</label>
		<div class="layui-input-inline" id="layerDemo">
			<script type="text/html" template>
				<input type="text" name="typeId" id="editCourseTypeId" lay-filter="editCourseTypeId" autocomplete="off" 
				    readonly  unselectable="on" placeholder="课程类型" class="layui-input">
					</script>
		</div>
		<label class="layui-form-label">课程属性</label>
		<div class="layui-input-inline" id="layerBute">
			<script type="text/html" template>
				<input type="text" name="attributeId" id="editCourseAttributeId" lay-filter="editCourseAttributeId" 
				    readonly  unselectable="on" autocomplete="off" placeholder="课程属性" class="layui-input">		
					</select>
				</script>
		</div>
	</div>
	<div class="layui-form-item">
		<label class="layui-form-label">课时(H)</label>
		<div class="layui-input-inline">
			<script type="text/html" template>
				<input type="text" name="hours" lay-verify="required" autocomplete="off" placeholder="课时(H)" class="layui-input">
			</script>
		</div>
		<label class="layui-form-label">证书等级</label>
		<div class="layui-input-inline">
			<script type="text/html" template>
				<input type="text" name="cerLevel" autocomplete="off" placeholder="证书等级" class="layui-input">
	        </script>
		</div>
	</div>
	<div class="layui-form-item">
		<label class="layui-form-label">有效天数</label>
		<div class="layui-input-inline">
			<script type="text/html" template>
				<input type="text" name="validDay" autocomplete="off" placeholder="有效天数" class="layui-input">
			</script>
		</div>
		<label class="layui-form-label">到岗x天培训</label>
		<div class="layui-input-inline">
			<script type="text/html" template>
				<input type="text" name="arrivalDay" autocomplete="off" placeholder="到岗x天培训" class="layui-input">
	        </script>
		</div>
	</div>
	<div class="layui-form-item">
		<label class="layui-form-label">快捷码</label>
		<div class="layui-input-inline">
			<script type="text/html" template>
				<input type="text" name="fastCode" autocomplete="off" placeholder="快捷码" class="layui-input">
        </script>
		</div>
		<label class="layui-form-label">部门级</label>
		<div class="layui-input-inline">
			<script type="text/html" template>
				<select name="isDept" lay-verify="required">
				<option value="1">是</option>
				<option value="2" selected="selected">否</option>
			</select>
			</script>
		</div>
	</div>
	<div class="layui-form-item">
		<label class="layui-form-label">启动</label>
		<div class="layui-input-inline">
			<script type="text/html" template>
				<select name="isUse" lay-verify="required">
				<option value="1" selected="selected">是</option>
				<option value="2">否</option>
			</select>
			</script>
		</div>
		<label class="layui-form-label">优先级别</label>
		<div class="layui-input-inline">
			<script type="text/html" template>
				<select name="priority" lay-verify="required">
				<option value="">--请选择--</option>
				<option value="1">必修</option>
				<option value="2">选修</option>
			</select>
			</script>
		</div>
	</div>
	<div class="layui-form-item">
		<label class="layui-form-label">培训形式</label>
		<div class="layui-input-inline">
			<script type="text/html" template>
				<select name="traForm" lay-verify="required">
				<option value="">--请选择--</option>
				<option value="1">外部公开课</option>
				<option value="2">外聘培训</option>
				<option value="3">内部培训</option>
			</select>
			</script>
		</div>
		<label class="layui-form-label">等效课程</label>
		<div class="layui-input-inline">
			<div class="layui-input-inline">
				<script type="text/html" template>
					<input type="text" name="topic" lay-verify="required" placeholder="等效课程" autocomplete="off" class="layui-input" />
				</script>
			</div>
		</div>
	</div>

     <input type="hidden" id="insertChildBook" name="courseFileBoList" />
	<input type="hidden" id="insertChildCourse" name="childCourseBoList" />
	<script type="text/html" template>
		<input type="hidden" name="id" />
	</script>


	<!-- 相关附件及子课程 begin -->
	<div class="layui-fluid">
		<div class="layui-card">
			<div class="layui-tab">
				<ul class="layui-tab-title">
					<li class="layui-this">相关课件</li>
					<li>子课程</li>
				</ul>
				<div class="layui-tab-content">
					<!--相关课件bengin  -->
					<div class="layui-tab-item layui-show">
						<div style="padding-bottom: 10px;">
							<button type="button" class="layui-btn layuiadmin-btn-list" id="addthinkpo">添加
							</button>
						</div>
						<table id="chek" lay-filter="chek"></table>

						<script type="text/html" id="childthink">
							{{#  if( d.type==1){ }}
                                    准备清单
                                    {{#  } else if  (d.type==2) { }}
                                    讲义
                                    {{#  } else if (d.type==3) { }}
                                    试卷
                                    {{#  } }}
                         </script>

						<script type="text/html" id="edit_chek">
							<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"><i
						            class="layui-icon layui-icon-delete"></i>删除</a>
						</script>

					</div>
					<!--相关课件end  -->

					<!--子课件bengin  -->
					<div class="layui-tab-item">
						<div style="padding-bottom: 10px;">
							<button type="button" class="layui-btn layuiadmin-btn-list" id="addChildCourse">添加
							</button>
						</div>
						<table id="book" lay-filter="book"></table>
						<script type="text/html" id="childTeacherTemplate">
							{{# if( sessionStorage.getItem("childTeacher" + d.teacherId)==null){ }}
						    {{#  } else {  }}
						    <span>{{ sessionStorage.getItem("childTeacher" + d.teacherId) }}</span>
						    {{#  } }}
						</script>
						<script type="text/html" id="edit_childCourse_table">
							<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"><i
						            class="layui-icon layui-icon-delete"></i>删除</a>
						</script>
					</div>

					<!--子课件end  -->
				</div>
			</div>
		</div>
	</div>

	<div class="layui-form-item">
		<label class="layui-form-label"></label>
		<div class="layui-input-inline">
			<input type="button" lay-submit lay-filter="layuiadmin-app-form-submit" id="confirm" value="确认" class="layui-btn">
		</div>
	</div>
</div>
<script>
	layui.use(['table', 'layer', 'admin', 'laydate', 'form'], function() {
		var table = layui.table;
		var $ = layui.$;
		var laydate = layui.laydate;
		var form = layui.form;

		var teacherList;

		var childCourseData = null;
		// 获取讲师数据列表
		function initHtml() {
			//讲师
			$.ajax({
				url: commonSrc + "api/train/teacherController/list?pageSize=99999&pageNum=1",
				type: "GET",
				dataType: "json",
				async: false,
				success: function(res) {
					var data = res.dataList;
					teacherList = data;
					// console.log("cccccc"+ teacherList);
					$.each(data, function(i, v) {
						// alert(v.name);
						// $("#teacherId").append('<option value="' + v.id + '">' + v.name + '</option>');
						sessionStorage.setItem("childTeacher" + v.id, v.name);
					});
					// console.log($("#teacherId").html());
				}
			});

		}

		initHtml();

		var data11 = [{
			'id': '',
			'childCourseName': '',
			'teacherId': ''
		}]
		var data12 = [{
			'id': '',
			'type': '',
			'fileId': ''
		}]
		//展示子课程已知数据
		table.render({
			elem: '#book',
			cols: [
				[ //标题栏
					{
						field: 'id',
						title: 'ID',
						width: 1,
						hidden: true
					}, {
						field: 'childCourseName',
						title: '子课程名称',
						edit: true,
						minWidth: 120
					}, {
						field: 'teacherId',
						title: '讲师',
						minWidth: 100,
						event: "cellClick",
						templet: '#childTeacherTemplate'
					}, {
						fixed: 'right',
						title: '操作',
						width: 100,
						align: 'center',
						toolbar: '#edit_childCourse_table'
					}
				]
			],
			done: function() {
				$("[data-field='id']").css('display', 'none');
			},
			data: data11
				//,skin: 'line' //表格风格
				,
			even: true
			//,page: true //是否显示分页
			//,limits: [5, 7, 10]
			//,limit: 5 //每页默认显示的数量
		});
		//展示相关附件类型
		table.render({
			elem: '#chek',
			cols: [
				[ //标题栏
					{
						field: 'id',
						title: 'ID',
						width: 1,
						hidden: true
					}, {
						field: 'type',
						title: '附件类型',
						event: "filethink",
						minWidth: 120,
						templet: '#childthink'
					}, {
						field: 'fileId',
						title: '附件名称',
						edit: true,
						minWidth: 120
					}, {
						fixed: 'right',
						title: '操作',
						width: 100,
						align: 'center',
						toolbar: '#edit_chek'
					}
				]
			],
			done: function() {
				$("[data-field='id']").css('display', 'none');
			},
			data: data12
				//,skin: 'line' //表格风格
				,
			even: true
			//,page: true //是否显示分页
			//,limits: [5, 7, 10]
			//,limit: 5 //每页默认显示的数量
		});
		//添加子课程空行
		$("#addChildCourse").click(function() {
			//定义一个空数组,用来存储之前编辑过的数据已经存放新数据
			var dataBak = [];
			console.log(table.cache);
			// 获取之前编辑过的全部数据，前提是编辑数据是要更新缓存，stock_add_table 为表格的id
			var tableBak = table.cache["book"];
			// console.log(tableBak)
			for (var i = 0; i < tableBak.length; i++) {
				dataBak.push(tableBak[i]); //将之前的数组备份
			}
			// console.log(dataBak)
			dataBak.push({
				"id": "",
				"childCourseName": "",
				"teacherId": ""
			});

			table.reload("book", {
				data: dataBak // 将新数据重新载入表格
			});
		});
		//添加相关附件空行
		$("#addthinkpo").click(function() {
			//定义一个空数组,用来存储之前编辑过的数据已经存放新数据
			var dataBak = [];
			console.log(table.cache);
			// 获取之前编辑过的全部数据，前提是编辑数据是要更新缓存，stock_add_table 为表格的id
			var tableBak = table.cache["chek"];
			// console.log(tableBak)
			for (var i = 0; i < tableBak.length; i++) {
				dataBak.push(tableBak[i]); //将之前的数组备份
			}
			// console.log(dataBak)
			dataBak.push({
				"id": "",
				"type": "",
				"fileId": ""
			});

			table.reload("chek", {
				data: dataBak // 将新数据重新载入表格
			});
		});
		//相关附件弹出层
		function filethink(that, obj) {
			//当前点击字段
			var field = $(that).data("field");
			//判断是否需要添加编辑框
			// if(field=="edit")return true;
			console.log(obj)
			//当前行数据
			var data = obj.data;
			//当前单元格的值
			var value = data[field];

			//当前点击td的宽高
			var height = $(that)[0].offsetHeight,
				width = $(that)[0].offsetWidth;
			//当前点击td的坐标
			var top = $(that).offset().top,
				left = $(that).offset().left;

			//输入框 这里可以自定义表单内容
			var input = '<select name="type" lay-search="" id="' + field + '_input" lay-filter="type" data-field="' + field +
				'" class="layui-form" style="width:' + width + 'px;height:' + height + 'px">' +
				'<option value="1">准备清单</option>' +
				'<option value="2">讲义</option>' +
				'<option value="3">试卷</option>' +
				'</select>';

			//弹出层
			layer.open({
				type: 1,
				title: false,
				page: true,
				limit: 1,
				closeBtn: 0,
				area: [width + "px", height + "px"],
				shade: [0.01, '#fff'],
				shadeClose: true,
				content: input //这里content是一个普通的String
					,
				offset: [top, left],
				success: function() {
					//console.log("success")
					//使弹出层相对定位
					$(".layui-layer-page").css("position", "absolute");
					//设置输入框的值
					$("#" + field + "_input").blur(function() {
						data[field] = $(this).val();
						obj.update(data);
					})
				}
			});
		}
		// 讲师弹出层
		function cellClick(that, obj) {
			// alert();
			//当前点击字段
			var field = $(that).data("field");
			//判断是否需要添加编辑框
			// if(field=="edit")return true;

			//当前行数据
			var data = obj.data;
			//当前单元格的值
			var value = data[field];

			//当前点击td的宽高
			var height = $(that)[0].offsetHeight,
				width = $(that)[0].offsetWidth;
			//当前点击td的坐标
			var top = $(that).offset().top,
				left = $(that).offset().left;

			//输入框 这里可以自定义表单内容
			var input = '<select name="childTeacherId" lay-search="" id="' + field +
				'_input" lay-filter="childTeacherId" data-field="' + field + '" class="layui-form" style="width:' + width +
				'px;height:' + height + 'px">' +
				'<option value="">请选择</option>' +
				'</select>';
			// var input = '<input type="text" lay-verify="date" placeholder="yyyy-MM-dd" class="layui-input" id="'+field+'_input" data-field="'+field+'" style="width:'+width+'px;height:'+height+'px">';

			//日期弹出层
			layer.open({
				type: 1,
				title: false,
				page: true,
				limit: 1,
				closeBtn: 0,
				area: [width + "px", height + "px"],
				shade: [0.01, '#fff'],
				shadeClose: true,
				content: input //这里content是一个普通的String
					,
				offset: [top, left],
				success: function() {
					// 讲师下拉列表
					$.each(teacherList, function(i, v) {
						// console.log(v.id);
						$("#" + field + "_input").append('<option value="' + v.id + '">' + v.name + '</option>');
					});
					//使弹出层相对定位
					$(".layui-layer-page").css("position", "absolute");

					//设置输入框的值
					$("#" + field + "_input").val(value);
					$("#" + field + "_input").blur(function() {
						//同步更新缓存对应的值
						data[field] = $(this).val();
						obj.update(data);
					})
				}
			});

		}

		// 监听子课程工具条
		table.on('tool(book)', function(obj) {
			switch (obj.event) {
				case 'cellClick':
					cellClick(this, obj);
					break;
			};
			var data = obj.data;
			if (obj.event === 'del') {
				layer.confirm('真的删除行么', function(index) {
					obj.del();
					layer.close(index);
				});
			} else if (obj.event === 'edit') {

			}
		});
		//监听相关附件
		table.on('tool(chek)', function(obj) {
			switch (obj.event) {
				case 'filethink':
					filethink(this, obj);
					break;
			};
			var data = obj.data;
			if (obj.event === 'del') {
				layer.confirm('真的删除行么', function(index) {
					obj.del();
					layer.close(index);
				});
			} else if (obj.event === 'edit') {

			}
		});


		$("#confirm").click(function() {
			var childCourseDataFlush = [];
			var CourseFileDataFlush = [];
			// 获取之前编辑过的全部数据，
			var tableBak1 = table.cache["book"];
			var tableBak = table.cache["chek"];
			for (var i = 0; i < tableBak1.length; i++) {
				if (tableBak1[i].id === undefined && tableBak1[i].childCourseName === undefined && tableBak1[i].teacherId === null) {
					continue;
				}
				var item = {
					'id': tableBak1[i].id,
					'name': tableBak1[i].childCourseName,
					'teacherId': tableBak1[i].teacherId
				}
				childCourseDataFlush.push(item); //将之前的数组备份
			}

			//相关附件
			for (var i = 0; i < tableBak.length; i++) {
				if (tableBak[i].id === undefined && tableBak[i].type === undefined && tableBak[i].fileId === null) {
					continue;
				}
				var item = {
					'id': tableBak[i].id,
					'type': tableBak[i].type,
					'fileId': tableBak[i].fileId
				}
				CourseFileDataFlush.push(item); //将之前的数组备份
			}
			
			$("#insertChildCourse").val(JSON.stringify(childCourseDataFlush));
			$("#insertChildBook").val(JSON.stringify(CourseFileDataFlush));
		});
	});
</script>
