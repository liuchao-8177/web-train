<div class="layui-card layadmin-header">
    <div class="layui-breadcrumb" lay-filter="breadcrumb">
        <a lay-href="">培训运作</a>
        <a><cite>记录评估/编辑</cite></a>
    </div>
</div>

<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-form  layuiadmin-card-header-auto" lay-filter="app-content-list">
            <!-- 搜索条件开始 -->

            <form action="" class="layui-form" method="post" style="padding-top: 30px">
                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">课程别名 :</label>
                        <div class="layui-input-inline">
                            <input type="text" name="otherName" id="otherName" autocomplete="off" placeholder="课程别名"
                                   class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">等效课程:</label>
                        <div class="layui-input-inline">
                            <input type="text" name="topic" id="topic" readonly="readonly" autocomplete="off"
                                   placeholder="等效课程" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">培训形式:</label>
                        <div class="layui-input-inline">
                            <select name="trainForm" id="trainForm" required="required" lay-filter="trainForm"
                                    class="layui-form"
                                    lay-verify="required" lay-search="">
                                <option value=""></option>
                                <option value="1">外部公开课</option>
                                <option value="2">外聘内训</option>
                                <option value="3">内部培训</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">培训机构:</label>
                        <div class="layui-input-inline">
                            <input type="text" name="agency" id="agency" autocomplete="off" placeholder="培训机构"
                                   class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">培训地点:</label>
                        <div class="layui-input-inline">
                            <input type="text" name="place" id="place" lay-verify="title" autocomplete="off"
                                   placeholder="培训地点"
                                   class="layui-input">
                        </div>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">对应证书:</label>
                        <div class="layui-input-inline">
                            <input type="text" name="cerLevel" id="cerLevel" readonly autocomplete="off"
                                   placeholder="对应证书"
                                   class="layui-input">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">开始日期:</label>
                        <div class="layui-input-inline">
                            <input type="text" name="startTime" class="layui-input date" id="test-laydate-start"
                                   placeholder="开始日期">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">结束日期:</label>
                        <div class="layui-input-inline">
                            <input type="text" name="endTime" class="layui-input date" id="test-laydate-end"
                                   placeholder="结束日期">
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">讲师:</label>
                        <div class="layui-input-inline">
                            <select name="teacherId" id="teacherId" lay-filter="teacherId" class="layui-form"
                                    lay-verify="required" lay-search="">
                                <option value="">请选择</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-form-item" style="text-align: right;">
                        <div class="layui-input-block">
                            <button type="button" class="layui-btn layuiadmin-btn-list" id="confirmEditEva">确定</button>
                            <a href="javascript:history.back(-1)">
                                <button type="button" class="layui-btn layui-btn-normal daainfor">返回</button>
                            </a>
                        </div>
                    </div>
                </div>
            </form>

            <!-- 搜索条件结束 -->

        </div>

        <div class="layui-card-body">
            <div class="layui-tab">
                <ul class="layui-tab-title layui-elem-field " style="margin-top: 30px;">
                    <li class="layui-this">参训学员</li>
                    <li>培训评估</li>
                    <li>相关附件</li>
                    <li>备注</li>
                    <li>子课程</li>
                </ul>

                <div class="layui-tab-content">
                    <!-- 参训学员 -->
                    <div class="layui-tab-item layui-show">
                        <div style="padding-bottom: 10px;">
                            <button type="button" class="layui-btn layuiadmin-btn-list" data-type="add">添加</button>
                        </div>
                        <table class="layui-hide" id="evaluation-course-list"
                               lay-filter="evaluation-course-list"></table>
                        <script type="text/html" id="isPass">
                            {{#  if(d.isPass==1){ }}
                            <button class="layui-btn layui-btn-danger layui-btn-xs">否</button>
                            {{#  } else {d.isPass==2  }}
                            <button class="layui-btn layui-btn-xs">是</button>
                            {{#  } }}
                        </script>
                        <script type="text/html" id="isProtocol">
                            {{#  if(d.isProtocol==1){ }}
                            <button class="layui-btn layui-btn-danger layui-btn-xs">否</button>
                            {{#  } else {d.isProtocol==2  }}
                            <button class="layui-btn layui-btn-xs">是</button>
                            {{#  } }}
                        </script>

                        <script type="text/html" id="table-content-list">
                            <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edits"><i
                                    class="layui-icon layui-icon-edit"></i>编辑</a>
                            <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"><i
                                    class="layui-icon layui-icon-delete"></i>删除</a>
                        </script>

                        <!--参训学员数据列表-->
                        <script>
                            layui.use(['admin', 'contlist', 'table', 'form', 'laydate'], function () {
                                var $ = layui.$,
                                    admin = layui.admin,
                                    view = layui.view,
                                    table = layui.table,
                                    laydate = layui.laydate,
                                    form = layui.form;

                                var planDetailId = layui.router().search.planDetailId;

                                //表格渲染
                                table.render({
                                    elem: '#evaluation-course-list',
                                    type: "GET",
                                    url: commonSrc + 'api/train/evaluationStudentController/selectEvaStudentList?detailId=' + planDetailId,
                                    //数据接口
                                    toolbar: '#toolbarDemo',
                                    response: {
                                        statusCode: 200 //规定成功的状态码，默认：0
                                    },
                                    request: {
                                        pageName: 'pageNum' //页码的参数名称，默认：page
                                        ,
                                        limitName: 'pageSize' //每页数据量的参数名，默认：limit
                                    },
                                    parseData: function (res) { //res 即为原始返回的数据
                                        // console.log(res);
                                        return {
                                            "code": res.code, //解析接口状态
                                            "msg": res.desc, //解析提示文本
                                            "count": res.total, //解析数据长度
                                            "data": res.dataList //解析数据列表
                                        };
                                    },
                                    //表头
                                    cols: [
                                        [{
                                            field: 'id',
                                            title: 'id',
                                            hide: true,
                                        }, {
                                            field: 'employId',
                                            title: '员工ID',
                                            align: 'center'
                                        }, {
                                            field: 'tuition',
                                            title: '学费',
                                            align: 'center'
                                        }, {
                                            field: 'travel',
                                            title: '差旅',
                                            align: 'center'
                                        }, {
                                            field: 'selfAmount',
                                            title: '个人支付',
                                            align: 'center'
                                        }, {
                                            field: 'costCenter',
                                            title: '成本中心',
                                            align: 'center'
                                        }, {
                                            field: 'isPass',
                                            title: '是否通过',
                                            templet: '#isPass',
                                            align: 'center'
                                        }, {
                                            field: 'isProtocol',
                                            title: '是否有协议',
                                            templet: '#isProtocol',
                                            align: 'center'
                                        }, {
                                            fixed: 'right',
                                            title: '操作',
                                            toolbar: '#table-content-list',
                                            align: 'center',
                                            minWidth: 150,
                                        }]
                                    ],
                                    page: !0,
                                    limit: 10,
                                    limits: [10, 15, 20, 25, 30],
                                }),

                                    table.on("tool(evaluation-course-list)", function (obj) {
                                        var data = obj.data;
                                        "del" === obj.event ? layer.confirm("确定删除此文章？", function (e) {
                                            $.ajax({
                                                url: commonSrc + "api/train/evaluationStudentController/deleteEvaStudent", //换成自己的url
                                                type: "POST",
                                                dataType: "json",
                                                data: {
                                                    id: data.id
                                                },
                                                success: function (b) {
                                                    layer.msg('删除成功');
                                                    obj.del(), layer.close(e),
                                                        layui.table.reload('evaluation-course-list'); //重载表格

                                                },
                                                error: function (e) {
                                                    layer.msg('删除失败')
                                                    layer.msg(e);
                                                }
                                            })
                                        }) : "edits" === obj.event && admin.popup({
                                            title: "编辑参训学员",
                                            area: ['720px', '700px'],
                                            id: "LAY-popup-content-edit",
                                            success: function (t, layero) {
                                                view(this.id).render("train/record/RecordStudentForm").done(function () {
                                                    $.ajax({
                                                        url: commonSrc + "api/train/evaluationStudentController/selectEvaStudentById", //换成自己的url
                                                        type: "GET",
                                                        dataType: "json",
                                                        data: {
                                                            id: data.id

                                                        },
                                                        success: function (e) {
                                                            //layer.msg(e.contractCheckVo);
                                                            let obj = e.data;
                                                            form.val("layuiadmin-app-form-list-recordStudent", obj);
                                                            //日期
                                                            $(".date").each(function () {
                                                                laydate.render({
                                                                    elem: this,
                                                                    trigger: 'click',
                                                                });
                                                            })
                                                        },
                                                        error: function (e) {
                                                            layer.msg(e);
                                                        }
                                                    })
                                                    form.render(null, "layuiadmin-app-form-list-recordStudent"),
                                                        form.on("submit(layuiadmin-app-form-submit)", function (
                                                            data) { //sub添加提交
                                                            // console.log(data.field);
                                                            $.post(commonSrc + "api/train/evaluationStudentController/updateEvaStudent",
                                                                data.field,
                                                                function (ev) {
                                                                    layer.msg("修改成功", {
                                                                        time: 1000
                                                                    }, function () {
                                                                        layui.table.reload("evaluation-course-list"), layer.close(layero)
                                                                    })
                                                                });
                                                            return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
                                                        })
                                                })
                                            }
                                        })
                                    })

                                form.render(null, 'LAY-app-content-list');

                                //监听搜索
                                form.on('submit(LAY-app-contlist-search)', function (data) {
                                    var field = data.field;
                                    // console.log(field);
                                    //执行重载
                                    table.reload('LAY-app-content-list', {
                                        where: field
                                    });
                                });

                                //多条删除
                                var active = {
                                    batchdelwag: function () {
                                        var checkStatus = table.checkStatus('LAY-app-content-list'),
                                            checkData = checkStatus.data; //得到选中的数据
                                        if (checkData.length === 0) {
                                            return layer.msg('请选择数据');
                                        }
                                        let arr = "";
                                        let arrTwo = "";
                                        for (var i in checkData) {
                                            arr += checkData[i].id + ",";
                                        }
                                        for (var i in checkData) {
                                            arrTwo += checkData[i].commonId + ",";
                                        }
                                        layer.confirm('确定删除吗？', function (index) {
                                            $.ajax({
                                                type: "POST",
                                                url: commonSrc + "api/train/evaluationStudentController/deleteEvaStudent",
                                                dataType: "json",
                                                data: {
                                                    id: arr,
                                                    traId: arrTwo
                                                },
                                                success: function (json) {
                                                    table.reload('LAY-app-content-list');
                                                    layer.msg('已删除');
                                                }
                                            });

                                        });
                                    }

                                    //添加
                                    ,
                                    add: function (othis) {
                                        admin.popup({
                                            title: '添加计划信息',
                                            area: ['720px', '700px'],
                                            id: 'LAY-popup-content-add',
                                            success: function (layero, index) {
                                                view(this.id).render('train/record/RecordAddForm').done(function () { //跳转
                                                    form.render(null, 'layuiadmin-app-form-list');
                                                    //日期
                                                    $(".date").each(function () {
                                                        laydate.render({
                                                            elem: this,
                                                            trigger: 'click',
                                                        });
                                                    })
                                                    //监听提交
                                                    form.on('submit(layuiadmin-app-form-submit)', function (data) {
                                                        var field = data.field; //获取提交的字段
                                                        $.post(commonSrc + "api/train/evaluationStudentController/insertEvaStudent",
                                                            data.field,
                                                            function (ev) {
                                                                layer.msg("新增成功", {
                                                                    time: 1000
                                                                }, function () {
                                                                    layer.close(index); //执行关闭
                                                                    layui.table.reload('LAY-app-content-list'); //重载表格
                                                                })
                                                            });
                                                        return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
                                                    });
                                                });
                                            }
                                        });
                                    }
                                };


                                $('.layui-btn.layuiadmin-btn-list').on('click', function () {
                                    var type = $(this).data('type');
                                    active[type] ? active[type].call(this) : '';
                                });

                                $(".date").each(function () {
                                    laydate.render({
                                        elem: this,
                                        trigger: 'click',
                                    });
                                })

                            });
                        </script>
                    </div>

                    <!--培训评估数据列表-->
                    <div class="layui-tab-item">
                        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                            <legend>讲师评估</legend>
                        </fieldset>
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label class="layui-form-label">讲师</label>
                                <div class="layui-input-inline">
                                    <input type="text" name="teacherName" id="teacherName" lay-verify="" readonly
                                           autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <input type="hidden" name="evaTeacherId">
                            <div class="layui-inline">
                                <label class="layui-form-label">课时</label>
                                <div class="layui-input-inline">
                                    <input type="text" name="planClass" id="planClass" lay-verify="" readonly
                                           autocomplete="off" class="layui-input">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">评估分</label>
                                <div class="layui-input-inline">
                                    <input type="text" name="tgrade" id="tgrade" lay-verify="" autocomplete="off"
                                           class="layui-input">
                                </div>
                            </div>
                        </div>
                        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                            <legend>课程评估</legend>
                        </fieldset>
                        <div class="layui-form-item">
                            <label class="layui-form-label">课程评分</label>
                            <div class="layui-input-inline">
                                <input type="text" name="cgrade" id="cgrade" lay-verify="" autocomplete="off"
                                       class="layui-input">
                            </div>
                            <!--                            <div class="layui-form-mid layui-word-aux">请填写6到12位密码</div>-->
                        </div>
                        <input type="hidden" name="evaCourseId">
                        <div class="layui-form-item layui-form-text">

                            <label class="layui-form-label">评语</label>
                            <div class="layui-input-block">
                                <textarea placeholder="请输入内容" class="layui-textarea" name="cremark" id="cremark"/>
                            </div>
                        </div>
                    </div>

                    <!--相关附件上传列表-->
                    <div class="layui-tab-item">
                        <div class="layui-upload">
                            <button type="button" class="layui-btn layui-btn-normal" id="addFile">添加文件</button>
                            <div class="layui-upload-list">
                                <table class="layui-table" id="LAY-app-content-list-file"
                                       lay-filter="LAY-app-content-list-file"></table>
                                <script type="text/html" id="fileTemplate">
                                    {{#  if( d.type==1){ }}
                                    准备清单
                                    {{#  } else if  (d.type==2) { }}
                                    讲义
                                    {{#  } else if (d.type==3) { }}
                                    试卷
                                    {{#  } }}
                                </script>
                                <script type="text/html" id="edit_file_table">
                                    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"><i
                                            class="layui-icon layui-icon-delete"></i>删除</a>
                                </script>
                            </div>
                        </div>
                    </div>

                    <!--备注-->
                    <div class="layui-tab-item">
                        <div class="layui-input-block">
                            <textarea placeholder="请输入内容" class="layui-textarea" name="remark" id="remark"/>
                        </div>
                    </div>
                    <!--子课程数据列表-->
                    <div class="layui-tab-item">
                        <div style="padding-bottom: 10px;">
                            <button type="button" class="layui-btn layuiadmin-btn-list" id="addChildCourse">添加
                            </button>
                            <!-- <button class="layui-btn layuiadmin-btn-list" data-type="add">添加</button> -->
                        </div>
                        <table id="LAY-app-content-list-childCourse"
                               lay-filter="LAY-app-content-list-childCourse"></table>
                        <script type="text/html" id="childTeacherTemplate">
                            {{# if( sessionStorage.getItem("childTeacher" + d.teacherId)==null){ }}
                            {{#  } else {  }}
                            <span>{{ sessionStorage.getItem("childTeacher" + d.teacherId) }}</span>
                            {{#  } }}
                        </script>
                        <script type="text/html" id="edit_childCourse_table">
                            <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"><i
                                    class="layui-icon layui-icon-delete"></i>删除</a>
                        </script>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>

    layui.use(['table', 'layer', 'admin', 'laydate', 'form'], function () {
        var table = layui.table;
        var $ = layui.$;
        var laydate = layui.laydate;
        var form = layui.form;
        var planDetailId = layui.router().search.planDetailId;

        var evadata;
        var evaluationCourse;
        var evaluationTeacher;
        var teacherList;


        // 修改时删除子课程及附件暂存
        var deCourseIds = [];
        var deFileIds = [];

        // 获取讲师数据列表


        function initHtml() {

            //获取评估数据
            $.ajax({
                url: commonSrc + "api/train/evaluationRecordController/selectEvaByDetailId?planDetailId=" + planDetailId,
                type: "get",
                dataType: "json",
                async: false,
                success: function (res) {
                    var data = res.data;
                    evadata = data;
                },
                error: function () {
                    alert("错误");
                }
            });
            //讲师
            $.ajax({
                url: commonSrc + "api/train/teacherController/list?pageSize=99999&pageNum=1",
                type: "GET",
                dataType: "json",
                async: false,
                success: function (res) {
                    var data = res.dataList;
                    teacherList = data;
                    $.each(data, function (i, v) {
                        if (evadata.teacherId == v.id) {
                            $("#teacherId").append('<option selected="selected" value="' + v.id + '">' + v.name + '</option>');
                        } else {
                            $("#teacherId").append('<option value="' + v.id + '">' + v.name + '</option>');
                        }
                        sessionStorage.setItem("childTeacher" + v.id, v.name);
                    });
                }
            });
        }

        initHtml();

        // 渲染表格数据
        $("#otherName").val(evadata.otherName);
        $("#topic").val(evadata.topic);
        $("#trainForm").val(evadata.trainForm);
        $("#agency").val(evadata.agency);
        $("#place").val(evadata.place);
        $("#cerLevel").val(evadata.cerLevel);
        $("#trainForm").val(evadata.trainForm);
        $("#teacherId").val(evadata.teacherId);


        $("#test-laydate-start").val(evadata.startTime);
        $("#test-laydate-end").val(evadata.endTime);
        form.render('select');


        // 获取对讲师评估数据
        evaluationTeacher = evadata.evaluationTeacherVo;
        $("#teacherName").val(sessionStorage.getItem("childTeacher" + evadata.teacherId));
        $("#planClass").val(evadata.planClass);
        $("#tgrade").val(evaluationTeacher.grade);

        // 获取对课程评估数据
        evaluationCourse = evadata.evaluationCourseVo;
        // console.log(evaluationTeacher)
        $("#cgrade").val(evaluationCourse.grade);
        $("#cremark").val(evaluationCourse.remark);

        // 备注
        $("#remark").val(evadata.remark);

        // console.log(evadata.evaChildCourseVos);

        //展示子课程已知数据
        table.render({
            elem: '#LAY-app-content-list-childCourse'
            , cols: [[ //标题栏
                {field: 'id', title: 'ID', width: 1, hidden: true}
                , {field: 'childCourseName', title: '子课程名称', edit: true, minWidth: 120}
                , {field: 'startTime', title: '开始时间', minWidth: 150, event: "cellClick"}
                , {field: 'endTime', title: '结束时间', minWidth: 160, event: "cellClick"}
                , {
                    field: 'teacherId',
                    title: '讲师',
                    minWidth: 100,
                    event: "cellClick2",
                    templet: '#childTeacherTemplate'
                }
                , {fixed: 'right', title: '操作', width: 100, align: 'center', toolbar: '#edit_childCourse_table'}
            ]]
            , done: function () {
                $("[data-field='id']").css('display', 'none');
            }
            , data: evadata.evaChildCourseVos
            //,skin: 'line' //表格风格
            , even: true
            //,page: true //是否显示分页
            //,limits: [5, 7, 10]
            //,limit: 5 //每页默认显示的数量
        });


        function CellClick(that, obj) {
            //当前点击字段
            var field = $(that).data("field");
            //判断是否需要添加编辑框
            // if(field=="edit")return true;

            //当前行数据
            var data = obj.data;
            //当前单元格的值
            var value = data[field];

            //当前点击td的宽高
            var height = $(that)[0].offsetHeight, width = $(that)[0].offsetWidth;
            //当前点击td的坐标
            var top = $(that).offset().top, left = $(that).offset().left;

            //输入框 这里可以自定义表单内容
            var input = '<input type="text" lay-verify="date" placeholder="yyyy-MM-dd" class="layui-input" id="' + field + '_input" data-field="' + field + '" style="width:' + width + 'px;height:' + height + 'px">';
            // var input = '<input type="text" c1ass="1ayui-input" id ="date" onclick="Rendering()">'

            //日期弹出层
            layer.open({
                type: 1
                , title: false
                , page: true
                , limit: 1
                , closeBtn: 0
                , area: [width + "px", height + "px"]
                , shade: [0.01, '#fff']
                , shadeClose: true
                , content: input //这里content是一个普通的String
                , offset: [top, left]
                , success: function () {
                    // 执行一个laydate实例
                    laydate.render({
                        elem: "#" + field + "_input", //指定元素
                        show: true,
                        type: 'date',
                        done: function (value, date, endDate) {
                            $("#" + field + "_input").val(value);
                            //同步更新缓存对应的值
                            data[field] = value;
                            obj.update(data);
                        }
                    });
                    // //使弹出层相对定位
                    $(".layui-layer-page").css("position", "absolute");
                    // //设置输入框的值
                    // $("#"+field+"_input").val(value);
                    // $("#"+field+"_input").blur(function(){
                    //     alert($("#"+field+"_input").val());

                    // })
                }
            });

        }

        // 讲师弹出层
        function CellClick2(that, obj) {
            //当前点击字段
            var field = $(that).data("field");
            //判断是否需要添加编辑框
            // if(field=="edit")return true;

            //当前行数据
            var data = obj.data;
            //当前单元格的值
            var value = data[field];

            //当前点击td的宽高
            var height = $(that)[0].offsetHeight, width = $(that)[0].offsetWidth;
            //当前点击td的坐标
            var top = $(that).offset().top, left = $(that).offset().left;

            //输入框 这里可以自定义表单内容
            var input = '<select name="childTeacherId" lay-search="" id="' + field + '_input" lay-filter="childTeacherId" data-field="' + field + '" class="layui-form" style="width:' + width + 'px;height:' + height + 'px">'
                + '<option value="">请选择</option>'
                + '</select>';
            // var input = '<input type="text" lay-verify="date" placeholder="yyyy-MM-dd" class="layui-input" id="'+field+'_input" data-field="'+field+'" style="width:'+width+'px;height:'+height+'px">';

            //日期弹出层
            layer.open({
                type: 1
                , title: false
                , page: true
                , limit: 1
                , closeBtn: 0
                , area: [width + "px", height + "px"]
                , shade: [0.01, '#fff']
                , shadeClose: true
                , content: input //这里content是一个普通的String
                , offset: [top, left]
                , success: function () {
                    // 讲师下拉列表
                    $.each(teacherList, function (i, v) {
                        // console.log(v.id);
                        $("#" + field + "_input").append('<option value="' + v.id + '">' + v.name + '</option>');
                    });
                    //使弹出层相对定位
                    $(".layui-layer-page").css("position", "absolute");

                    //设置输入框的值
                    $("#" + field + "_input").val(value);
                    $("#" + field + "_input").blur(function () {
                        //同步更新缓存对应的值
                        data[field] = $(this).val();
                        obj.update(data);
                    })
                }
            });

        }

        // 监听子课程工具条
        table.on('tool(LAY-app-content-list-childCourse)', function (obj) {
            switch (obj.event) {
                case 'cellClick':
                    CellClick(this, obj);
                    break;
                case 'cellClick2':
                    CellClick2(this, obj);
                    break;
            }
            ;
            var data = obj.data;
            if (obj.event === 'del') {
                layer.confirm('真的删除行么', function (index) {
                    deCourseIds.push(obj.data.id);
                    // console.log(obj.data.id);
                    obj.del();
                    layer.close(index);
                });
            } else if (obj.event === 'edit') {

            }
        });

        // 添加子课程空行
        // 监听添加子课程按钮
        $("#addChildCourse").click(function () {
            //定义一个空数组,用来存储之前编辑过的数据已经存放新数据
            var dataBak = [];

            // 获取之前编辑过的全部数据，前提是编辑数据是要更新缓存，stock_add_table 为表格的id
            var tableBak = table.cache["LAY-app-content-list-childCourse"];

            for (var i = 0; i < tableBak.length; i++) {
                dataBak.push(tableBak[i]);      //将之前的数组备份
            }

            dataBak.push({
                "id": ""
                , "childCourseName": ""
                , "startTime": ""
                , "endTime": ""
                , "teacherId": ""
            });

            table.reload("LAY-app-content-list-childCourse", {
                data: dataBak   // 将新数据重新载入表格
            });
        });

        //展示课程附件已知数据
        table.render({
            elem: '#LAY-app-content-list-file'
            , cols: [[ //标题栏
                {field: 'id', title: 'ID', width: 1, hidden: true}
                , {field: 'type', title: '文件类型', event: "fileCellClick", minWidth: 120, templet: '#fileTemplate'}
                , {field: 'fileId', title: '文件', minWidth: 100, edit: true}
                , {fixed: 'right', title: '操作', width: 100, align: 'center', toolbar: '#edit_file_table'}
            ]]
            , done: function () {
                $("[data-field='id']").css('display', 'none');
            }
            , data: evadata.planFileVoList
            //,skin: 'line' //表格风格
            , even: true
            //,page: true //是否显示分页
            //,limits: [5, 7, 10]
            //,limit: 5 //每页默认显示的数量
        });

        // 课程附件类型弹出
        function fileCellClick(that, obj) {
            //当前点击字段
            var field = $(that).data("field");
            //判断是否需要添加编辑框
            // if(field=="edit")return true;

            //当前行数据
            var data = obj.data;
            //当前单元格的值
            var value = data[field];

            //当前点击td的宽高
            var height = $(that)[0].offsetHeight, width = $(that)[0].offsetWidth;
            //当前点击td的坐标
            var top = $(that).offset().top, left = $(that).offset().left;

            //输入框 这里可以自定义表单内容
            var input = '<select name="type" lay-search="" id="' + field + '_input" lay-filter="type" data-field="' + field + '" class="layui-form" style="width:' + width + 'px;height:' + height + 'px">'
                + '<option value="1">准备清单</option>'
                + '<option value="2">讲义</option>'
                + '<option value="1">试卷</option>'
                + '</select>';

            //弹出层
            layer.open({
                type: 1
                , title: false
                , page: true
                , limit: 1
                , closeBtn: 0
                , area: [width + "px", height + "px"]
                , shade: [0.01, '#fff']
                , shadeClose: true
                , content: input //这里content是一个普通的String
                , offset: [top, left]
                , success: function () {
                    //使弹出层相对定位
                    $(".layui-layer-page").css("position", "absolute");
                    //设置输入框的值
                    $("#" + field + "_input").val(value);
                    $("#" + field + "_input").blur(function () {
                        //同步更新缓存对应的值
                        data[field] = $(this).val();
                        obj.update(data);
                    })
                }
            });
        }

        // 监听附件工具条
        table.on('tool(LAY-app-content-list-file)', function (obj) {
            switch (obj.event) {
                case 'fileCellClick':
                    fileCellClick(this, obj);
                    break;
                // case 'cellClick2':
                //     CellClick2(this,obj);
                //     break;
            }
            ;
            var data = obj.data;
            if (obj.event === 'del') {
                layer.confirm('真的删除行么', function (index) {
                    deFileIds.push(obj.data.id);
                    obj.del();
                    layer.close(index);
                });
            } else if (obj.event === 'edit') {

            }
        });

        // 添加课程附件空行
        // 监听添加子课程按钮
        $("#addFile").click(function () {
            //定义一个空数组,用来存储之前编辑过的数据已经存放新数据
            var dataBak = [];
            // 获取之前编辑过的全部数据，前提是编辑数据是要更新缓存，stock_add_table 为表格的id
            var tableBak = table.cache["LAY-app-content-list-file"];
            for (var i = 0; i < tableBak.length; i++) {
                dataBak.push(tableBak[i]);      //将之前的数组备份
            }
            dataBak.push({
                "id": ""
                , "type": ""
                , "fileId": ""
            });
            table.reload("LAY-app-content-list-file", {
                data: dataBak   // 将新数据重新载入表格
            });
        });

        // //监听单元格编辑
        // table.on('edit(LAY-app-content-list-childCourse)', function (obj) {
        //     var value = obj.value //得到修改后的值
        //         , data = obj.data //得到所在行所有键值
        //         , field = obj.field; //得到字段
        //     layer.msg('[ID: ' + data.id + '] ' + field + ' 字段更改为：' + value);
        // });

        // 确认修改
        $("#confirmEditEva").click(function () {

            // // 修改
            // Object.keys(table.cache["LAY-app-content-list-childCourse"]).forEach(function(key){
            //     console.log(key,obj[key]);
            //
            // });
            // table

            var childCourseDataFlush = [];
            var fileDataFlush = [];
            // 获取之前编辑过的全部数据，
            var tableBak = table.cache["LAY-app-content-list-childCourse"];
            var tableBak1 = table.cache["LAY-app-content-list-file"];
            for (var i = 0; i < tableBak.length; i++) {
                if (tableBak[i].id === undefined && tableBak[i].childCourseName === undefined && tableBak[i].startTime === undefined
                    && tableBak[i].endTime === undefined && tableBak[i].teacherId === null) {
                    continue;
                }
                var item = {
                    'id': tableBak[i].id,
                    'childCourseName': tableBak[i].childCourseName,
                    'startTime': tableBak[i].startTime,
                    'endTime': tableBak[i].endTime,
                    'teacherId': tableBak[i].teacherId
                }
                childCourseDataFlush.push(item);      //将之前的数组备份
            }
            for (var i = 0; i < tableBak1.length; i++) {
                if (tableBak1[i].id === undefined && tableBak1[i].type === undefined && tableBak1[i].fileId === undefined) {
                    continue;
                }
                var item = {
                    'id': tableBak1[i].id,
                    'type': tableBak1[i].type,
                    'fileId': tableBak1[i].fileId
                }
                fileDataFlush.push(item);      //将之前的数组备份
            }
            // console.log("---" + fileDataFlush[0].id);

            var data = {
                'agency': $("#agency").val()
                , 'courseRemark': $("#cremark").val()
                , 'courseGrade': $("#cgrade").val()

                // 删除子课程集合
                , 'dePlanDetailIds': deCourseIds
                // 删除附件集合
                , 'dePlanFileIds': deFileIds

                , 'endTime': $("#test-laydate-end").val()
                , 'startTime': $("#test-laydate-start").val()

                // 修改子课程及新增的子课程
                , 'evaChildCourseBos': childCourseDataFlush

                // 修改的附件及新增的附件
                , 'planFileBos': fileDataFlush

                // ,'planClass': $("#planClass").val()
                , 'planDetailId': planDetailId
                , 'otherName': $("#otherName").val()
                , 'place': $("#place").val()
                , 'remark': $("#remark").val()
                , 'teacherGrade': $("#tgrade").val()
                , 'teacherId': $("#teacherId").val()
                , 'trainForm': $("#trainForm").val()

            }

            // console.log(JSON.stringify(data));
            $.ajax({
                type: "post",
                contentType: "application/json;charset=UTF-8",
                dataType: 'json',
                url: commonSrc + "api/train/evaluationRecordController/updateEvaluation",
                data: JSON.stringify(data),
                success: function (result) {
                    layer.msg("修改成功", {
                        time: 1000
                    }, function () {
                        layer.close(index); //执行关闭
                        // layui.table.reload('LAY-app-content-list'); //重载表格
                    })
                },
                error: function (result) {
                    console.log("error :" + result);
                }
            });
        });
    });
</script>